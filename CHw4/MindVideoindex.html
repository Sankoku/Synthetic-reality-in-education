<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>WebAR –î–æ–º–∞—à–Ω—î –∑–∞–≤–¥–∞–Ω–Ω—è 4</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image-three.prod.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
                "GLTFLoader": "https://unpkg.com/three@0.150.1/examples/jsm/loaders/GLTFLoader.js"
            }
        }
    </script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 14px;
            z-index: 99;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            max-width: 350px;
            font-family: monospace;
        }

        .marker-status {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }

        .marker-active {
            background-color: rgba(0, 255, 0, 0.2);
        }

        .marker-inactive {
            background-color: rgba(255, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div id="loading">
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ AR —Å–∏—Å—Ç–µ–º—ã...</div>
        <div style="font-size: 14px; margin-top: 10px;">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ</div>
    </div>
    
    <div id="status">
        <div id="main-status">–°—Ç–∞—Ç—É—Å: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        <div id="marker1-status" class="marker-status marker-inactive">–ú–∞—Ä–∫–µ—Ä 1: –í–∏–¥–µ–æ –æ–± –æ–∫–µ–∞–Ω–µ - –ù–ï –ù–ê–ô–î–ï–ù</div>
        <div id="marker2-status" class="marker-status marker-inactive">–ú–∞—Ä–∫–µ—Ä 2: –ú–æ–¥–µ–ª—å –∫–æ—Ä–∞–±–ª—è - –ù–ï –ù–ê–ô–î–ï–ù</div>
        <div style="font-size: 12px; margin-top: 10px;">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä—ã<br>–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–æ—Ä–∞–±–ª—é –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è</div>
    </div>

    <script type="module">
        import * as THREE from "three";
        import { GLTFLoader } from "GLTFLoader";

        window.addEventListener("DOMContentLoaded", () => {
            let mindarThree1, mindarThree2;
            let renderer, scene, camera;
            let shipModel = null;
            let currentRotation = 0;
            let isInitialized = false;

            const start = async () => {
                try {
                    const { MindARThree } = window.MINDAR.IMAGE;
                    
                    updateMainStatus("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞...");
                    
                    // === –ü–ï–†–í–´–ô –ú–ê–†–ö–ï–† (marker.mind) - –í–ò–î–ï–û –û–ë –û–ö–ï–ê–ù–ï ===
                    mindarThree1 = new MindARThree({
                        container: document.body,
                        imageTargetSrc: "./marker.mind",
                    });

                    const { renderer: renderer1, scene: scene1, camera: camera1 } = mindarThree1;
                    renderer = renderer1;
                    scene = scene1;
                    camera = camera1;

                    const videoAnchor = mindarThree1.addAnchor(0);

                    // –û—Å–≤–µ—â–µ–Ω–∏–µ
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                    scene.add(ambientLight);

                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(1, 1, 1);
                    scene.add(directionalLight);

                    // –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ –æ–± –æ–∫–µ–∞–Ω–µ
                    const video = document.createElement('video');
                    video.crossOrigin = 'anonymous';
                    video.loop = true;
                    video.muted = true;
                    video.playsInline = true;
                    video.preload = 'metadata';
                    video.src = './video.mp4';
                    
                    let videoLoaded = false;

                    // –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ –ø–ª–æ—Å–∫–æ—Å—Ç–∏
                    const videoTexture = new THREE.VideoTexture(video);
                    videoTexture.minFilter = THREE.LinearFilter;
                    videoTexture.magFilter = THREE.LinearFilter;
                    
                    const videoMaterial = new THREE.MeshBasicMaterial({
                        map: videoTexture,
                        side: THREE.DoubleSide
                    });
                    
                    const videoGeometry = new THREE.PlaneGeometry(1.6, 0.9); // 16:9 —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ
                    const videoMesh = new THREE.Mesh(videoGeometry, videoMaterial);
                    videoMesh.position.set(0, 0, 0.1);
                    
                    videoAnchor.group.add(videoMesh);

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∏–¥–µ–æ
                    video.addEventListener('loadeddata', () => {
                        console.log("‚úÖ –í–∏–¥–µ–æ –æ–± –æ–∫–µ–∞–Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ");
                        videoLoaded = true;
                    });

                    video.addEventListener('error', (e) => {
                        console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –æ–± –æ–∫–µ–∞–Ω–µ:", e);
                        // –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ —Ü–≤–µ—Ç–Ω—É—é –ø–ª–æ—Å–∫–æ—Å—Ç—å –µ—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
                        const fallbackMaterial = new THREE.MeshBasicMaterial({
                            color: 0x0077be, // —Ü–≤–µ—Ç –æ–∫–µ–∞–Ω–∞
                            side: THREE.DoubleSide
                        });
                        videoMesh.material = fallbackMaterial;
                    });

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ (–≤–∏–¥–µ–æ)
                    videoAnchor.onTargetFound = () => {
                        console.log("üéØ –ú–ê–†–ö–ï–† 1 –ù–ê–ô–î–ï–ù! –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ –æ–± –æ–∫–µ–∞–Ω–µ");
                        updateMarkerStatus(1, true);
                        
                        if (videoLoaded) {
                            video.play().catch(e => console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ:", e));
                        }
                    };

                    videoAnchor.onTargetLost = () => {
                        console.log("‚ùå –ú–∞—Ä–∫–µ—Ä 1 –ø–æ—Ç–µ—Ä—è–Ω - –≤–∏–¥–µ–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
                        updateMarkerStatus(1, false);
                        video.pause();
                    };

                    updateMainStatus("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ç–æ—Ä–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞...");

                    // === –í–¢–û–†–û–ô –ú–ê–†–ö–ï–† (marker2.mind) - –ú–û–î–ï–õ–¨ –ö–û–†–ê–ë–õ–Ø ===
                    mindarThree2 = new MindARThree({
                        container: document.body,
                        imageTargetSrc: "./marker2.mind",
                    });

                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ renderer –∏ scene
                    mindarThree2.renderer = renderer;
                    mindarThree2.scene = scene;
                    mindarThree2.camera = camera;

                    const shipAnchor = mindarThree2.addAnchor(0);

                    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –∫–æ—Ä–∞–±–ª—è
                    const loader = new GLTFLoader();
                    
                    // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø—É—Ç–∏ –∫ –º–æ–¥–µ–ª–∏ –∫–æ—Ä–∞–±–ª—è
                    const shipModels = [
                        "./ship/scene.gltf", // –≤–∞—à–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å
                        "ship/scene.gltf", // –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å
                        "https://raw.githubusercontent.com/hiukim/mind-ar-js/master/examples/image-tracking/assets/band-example/raccoon/scene.gltf", // —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –º–æ–¥–µ–ª—å
                    ];
                    
                    let modelLoaded = false;
                    
                    const loadShipModel = (modelIndex = 0) => {
                        if (modelIndex >= shipModels.length) {
                            console.log("–°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –º–æ–¥–µ–ª—å –∫–æ—Ä–∞–±–ª—è –∏–∑ –ø—Ä–∏–º–∏—Ç–∏–≤–æ–≤");
                            createSimpleShip();
                            return;
                        }
                        
                        console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: ${shipModels[modelIndex]}`);
                        
                        loader.load(
                            shipModels[modelIndex],
                            (gltf) => {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏
                                if (gltf.animations && gltf.animations.length > 0) {
                                    console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –∞–Ω–∏–º–∞—Ü–∏–π: ${gltf.animations.length}`);
                                }
                                
                                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Å—à—Ç–∞–±–∞ –∏ –ø–æ–∑–∏—Ü–∏–∏ - –º–æ–¥–µ–ª—å —Ç–æ—á–Ω–æ –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ
                                gltf.scene.scale.set(0.5, 0.5, 0.5);
                                gltf.scene.position.set(-0.5, 2, 0); // –ø–æ–∑–∏—Ü–∏—è —Ç–æ—á–Ω–æ –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ
                                gltf.scene.userData.clickable = true;
                                gltf.scene.userData.isShip = true;
                                
                                shipModel = gltf.scene;
                                shipAnchor.group.add(gltf.scene);
                                modelLoaded = true;
                                
                                console.log("‚úÖ –ú–æ–¥–µ–ª—å –∫–æ—Ä–∞–±–ª—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑:", shipModels[modelIndex]);
                            },
                            (progress) => {
                                console.log(`üìä –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${(progress.loaded / progress.total * 100).toFixed(1)}%`);
                            },
                            (error) => {
                                console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ ${shipModels[modelIndex]}:`, error);
                                loadShipModel(modelIndex + 1);
                            }
                        );
                    };

                    // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–π –º–æ–¥–µ–ª–∏ –∫–æ—Ä–∞–±–ª—è –∏–∑ –ø—Ä–∏–º–∏—Ç–∏–≤–æ–≤
                    const createSimpleShip = () => {
                        const shipGroup = new THREE.Group();
                        
                        // –ö–æ—Ä–ø—É—Å –∫–æ—Ä–∞–±–ª—è
                        const hullGeometry = new THREE.BoxGeometry(0.4, 0.1, 0.8);
                        const hullMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
                        const hull = new THREE.Mesh(hullGeometry, hullMaterial);
                        hull.position.y = -0.05;
                        
                        // –ú–∞—á—Ç–∞
                        const mastGeometry = new THREE.CylinderGeometry(0.01, 0.01, 0.3);
                        const mastMaterial = new THREE.MeshLambertMaterial({ color: 0x654321 });
                        const mast = new THREE.Mesh(mastGeometry, mastMaterial);
                        mast.position.y = 0.1;
                        
                        // –ü–∞—Ä—É—Å
                        const sailGeometry = new THREE.PlaneGeometry(0.2, 0.25);
                        const sailMaterial = new THREE.MeshLambertMaterial({ 
                            color: 0xFFFFF0, 
                            side: THREE.DoubleSide 
                        });
                        const sail = new THREE.Mesh(sailGeometry, sailMaterial);
                        sail.position.set(0.1, 0.1, 0);
                        
                        shipGroup.add(hull);
                        shipGroup.add(mast);
                        shipGroup.add(sail);
                        
                        shipGroup.userData.clickable = true;
                        shipGroup.userData.isShip = true;
                        shipGroup.position.set(0, 0, 0); // –ø—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å —Ç–æ–∂–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ
                        shipGroup.scale.set(0.5, 0.5, 0.5);
                        
                        shipModel = shipGroup;
                        shipAnchor.group.add(shipGroup);
                        modelLoaded = true;
                        
                        console.log("‚úÖ –ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å –∫–æ—Ä–∞–±–ª—è —Å–æ–∑–¥–∞–Ω–∞");
                    };

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ (–∫–æ—Ä–∞–±–ª—å)
                    shipAnchor.onTargetFound = () => {
                        console.log("üéØ –ú–ê–†–ö–ï–† 2 –ù–ê–ô–î–ï–ù! –ú–æ–¥–µ–ª—å –∫–æ—Ä–∞–±–ª—è –∞–∫—Ç–∏–≤–Ω–∞");
                        updateMarkerStatus(2, true);
                    };

                    shipAnchor.onTargetLost = () => {
                        console.log("‚ùå –ú–∞—Ä–∫–µ—Ä 2 –ø–æ—Ç–µ—Ä—è–Ω");
                        updateMarkerStatus(2, false);
                    };

                    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –∫–æ—Ä–∞–±–ª—è
                    loadShipModel();

                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è –∫–æ—Ä–∞–±–ª—è
                    document.body.addEventListener("click", (e) => {
                        if (!modelLoaded || !shipModel) return;
                        
                        // –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –µ–∫—Ä–∞–Ω—É –≤ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ [-1, 1]
                        const mouseX = (e.clientX / window.innerWidth) * 2 - 1;
                        const mouseY = -((e.clientY / window.innerHeight) * 2 - 1);
                        
                        const mouse = new THREE.Vector2(mouseX, mouseY);
                        
                        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–π–∫–∞—Å—Ç–µ—Ä–∞
                        const raycaster = new THREE.Raycaster();
                        raycaster.setFromCamera(mouse, camera);
                        
                        // –ü–æ—à—É–∫ –ø–µ—Ä–µ—Ç–∏–Ω—ñ–≤ –∑ –æ–±'—î–∫—Ç–∞–º–∏ —Å—Ü–µ–Ω–∏
                        const intersects = raycaster.intersectObjects(scene.children, true);
                        
                        if (intersects.length > 0) {
                            let object = intersects[0].object;
                            
                            // –ü–æ—à—É–∫ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–≥–æ –æ–±'—î–∫—Ç–∞ –∑ –º—ñ—Ç–∫–æ—é –∫–æ—Ä–∞–±–ª—è
                            while (object.parent && !object.userData.isShip) {
                                object = object.parent;
                            }
                            
                            if (object.userData.isShip) {
                                // –í–∏–∫–æ–Ω–∞–Ω–Ω—è –æ–±–µ—Ä—Ç–∞–Ω–Ω—è –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ
                                performShipRotation(object);
                            }
                        }
                    });

                    // –§—É–Ω–∫—Ü–∏—è –ø–æ–≤–æ—Ä–æ—Ç–∞ –∫–æ—Ä–∞–±–ª—è
                    function performShipRotation(shipObject) {
                        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ –∫—É—Ç–∞ –≤—ñ–¥ 45 –¥–æ 90 –≥—Ä–∞–¥—É—Å—ñ–≤
                        const randomAngle = (Math.random() * 45 + 45) * Math.PI / 180;
                        
                        // –î–æ–¥–∞–≤–∞–Ω–Ω—è –¥–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫—É—Ç–∞
                        currentRotation += randomAngle;
                        
                        // –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –æ–±–µ—Ä—Ç–∞–Ω–Ω—è
                        shipObject.rotation.set(0, currentRotation, 0);
                        
                        console.log(`üîÑ –ö–æ—Ä–∞–±–ª—å –ø–æ–≤–µ—Ä–Ω—É—Ç –Ω–∞ ${(randomAngle * 180 / Math.PI).toFixed(1)} –≥—Ä–∞–¥—É—Å–æ–≤`);
                    }

                    // –ó–∞–ø—É—Å–∫ –æ–±–æ–∏—Ö —Å–∏—Å—Ç–µ–º
                    updateMainStatus("–ó–∞–ø—É—Å–∫ AR –∫–∞–º–µ—Ä—ã...");
                    
                    await mindarThree1.start();
                    await mindarThree2.start();
                    
                    updateMainStatus("‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞! –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä—ã");
                    isInitialized = true;

                    // –¶–∏–∫–ª —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                    renderer.setAnimationLoop(() => {
                        renderer.render(scene, camera);
                    });

                } catch (error) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
                    updateMainStatus("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏");
                }
            };

            // –§—É–Ω–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
            function updateMainStatus(message) {
                const statusDiv = document.getElementById('main-status');
                if (statusDiv) {
                    statusDiv.textContent = `–°—Ç–∞—Ç—É—Å: ${message}`;
                }
            }

            function updateMarkerStatus(markerNum, isActive) {
                const statusDiv = document.getElementById(`marker${markerNum}-status`);
                if (statusDiv) {
                    const content = markerNum === 1 ? '–í–∏–¥–µ–æ –æ–± –æ–∫–µ–∞–Ω–µ' : '–ú–æ–¥–µ–ª—å –∫–æ—Ä–∞–±–ª—è';
                    const status = isActive ? '–ù–ê–ô–î–ï–ù' : '–ù–ï –ù–ê–ô–î–ï–ù';
                    
                    statusDiv.textContent = `–ú–∞—Ä–∫–µ—Ä ${markerNum}: ${content} - ${status}`;
                    statusDiv.className = `marker-status ${isActive ? 'marker-active' : 'marker-inactive'}`;
                }
            }

            // –ó–∞–ø—É—Å–∫
            start().catch(console.error);

            // –°–∫—Ä—ã—Ç–∏–µ –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
            setTimeout(() => {
                const loading = document.getElementById("loading");
                if (loading) loading.style.display = "none";
            }, 5000);
        });
    </script>
</body>
</html>